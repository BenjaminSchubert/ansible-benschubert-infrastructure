---
- name: Prepare hosts
  hosts: all

  tasks:
    - name: Configure /etc/hosts
      become: true
      ansible.builtin.copy:
        content: |
          {{ template_warning }}
          127.0.0.1       localhost molecule-benschubert-infrastructure {{ hostnames | join(' ') }}
          ::1             localhost ip6-localhost ip6-loopback
          ff02::1         ip6-allnodes
          ff02::2         ip6-allrouters
        dest: /etc/hosts
        mode: "0o644"

    - name: Configure apt proxy
      become: true
      when: apt_proxy | default("") | length > 0
      ansible.builtin.copy:
        content: |
          {{ template_warning }}
          Acquire::http::Proxy "{{ apt_proxy }}";
        dest: /etc/apt/apt.conf.d/80-proxy
        mode: "0o644"

    - name: Remove default repositories
      become: true
      ansible.builtin.file:
        path: /etc/apt/sources.list
        state: absent

    - name: Configure debian sources
      become: true
      ansible.builtin.deb822_repository:
        name: debian
        types:
          - deb
          - deb-src
        uris: http://deb.debian.org/debian
        # yamllint disable-line rule:line-length
        suites: "{{ ansible_facts.distribution_release }} {{ ansible_facts.distribution_release }}-updates"
        components: main contrib
        signed_by: /usr/share/keyrings/debian-archive-keyring.gpg

    - name: Configure debian security sources
      become: true
      ansible.builtin.deb822_repository:
        name: debian-security
        types:
          - deb
          - deb-src
        uris: http://security.debian.org/debian-security
        suites: "{{ ansible_facts.distribution_release }}-security"
        components: main contrib
        signed_by: /usr/share/keyrings/debian-archive-keyring.gpg

    - name: Ensure all packages are up to date
      become: true
      ansible.builtin.apt:
        name: "*"
        state: latest
        update_cache: true

    - name: Install packages
      become: true
      ansible.builtin.apt:
        name:
          - aardvark-dns
          - bash
          - busybox-static
          - ca-certificates
          - catatonit
          - dbus-user-session
          - init
          - iproute2
          - nftables
          - passt
          - podman
          - python3
          - sudo
          - systemd
          - uidmap
          # And some utilities to help debug
          - curl
          - jq
          - less

    - name: Setup isolated hosts for podman internal
      become: true
      ansible.builtin.copy:
        content: |
          127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
          ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
        dest: /etc/containers/isolated_hosts
        mode: "0o644"

    - name: Setup containers configuration
      become: true
      ansible.builtin.copy:
        content: |
          [containers]
          base_hosts_file = "/etc/containers/isolated_hosts"
        dest: /etc/containers/containers.conf
        mode: "0o644"

    - name: Setup registries
      become: true
      ansible.builtin.copy:
        src: "{{ registries_conf }}"
        dest: /etc/containers/registries.conf.d/050-registries.conf
        mode: "0o644"
      when: registries_conf is not none

    - name: Setup sub{u,g}id
      become: true
      ansible.builtin.copy:
        content: |
          containers:100000:65536
        dest: /etc/{{ item }}
        mode: "0o644"
      loop:
        - subuid
        - subgid

    - name: Reboot
      become: true
      ansible.builtin.reboot:
